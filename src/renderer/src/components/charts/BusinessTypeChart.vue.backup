<template>
  <!-- ä¸šåŠ¡ç±»å‹åˆ†å¸ƒç»Ÿè®¡ -->
  <div class="w-full h-full">
    <!-- å›¾è¡¨æ ‡é¢˜å’Œæ§åˆ¶å™¨ -->
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="text-lg font-semibold">{{ title }}</h3>
        <p class="text-sm text-muted-foreground">{{ subtitle }}</p>
      </div>
      <div class="flex items-center space-x-2">
        <!-- ä¸šåŠ¡ç±»å‹åˆ‡æ¢ -->
        <select
          v-model="selectedBusinessType"
          class="px-3 py-1.5 text-xs border rounded-md bg-background hover:bg-muted/50 transition-colors focus:outline-none focus:ring-2 focus:ring-primary/20"
          @change="handleBusinessTypeChange"
        >
          <option value="all">å…¨éƒ¨ä¸šåŠ¡</option>
          <option value="atm">ATMä¸šåŠ¡</option>
          <option value="fx">å¤–æ±‡ä¸šåŠ¡</option>
        </select>

        <!-- æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢ -->
        <select
          v-model="displayMode"
          class="px-3 py-1.5 text-xs border rounded-md bg-background hover:bg-muted/50 transition-colors focus:outline-none focus:ring-2 focus:ring-primary/20"
          @change="handleDisplayModeChange"
        >
          <option value="overview">æ€»è§ˆæ¨¡å¼</option>
          <option value="detailed">è¯¦ç»†åˆ†æ</option>
          <option value="comparison">å¯¹æ¯”åˆ†æ</option>
        </select>

        <!-- åˆ·æ–°æŒ‰é’® -->
        <Button variant="ghost" size="sm" :disabled="isLoading" @click="refreshData">
          <RefreshCw :class="['w-3 h-3', isLoading ? 'animate-spin' : '']" />
        </Button>
      </div>
    </div>

    <!-- å›¾è¡¨å®¹å™¨ -->
    <div
      ref="chartContainer"
      class="w-full chart-container bg-gradient-to-br from-slate-50/80 to-blue-50/80 dark:from-gray-900/80 dark:to-slate-800/80 rounded-xl border shadow-sm"
      :style="chartContainerStyle"
    >
      <!-- åŠ è½½çŠ¶æ€ -->
      <div v-if="isLoading" class="flex items-center justify-center h-full">
        <div class="flex flex-col items-center space-y-3">
          <RefreshCw class="w-8 h-8 animate-spin text-primary" />
          <p class="text-sm text-muted-foreground">æ­£åœ¨åŠ è½½ä¸šåŠ¡æ•°æ®...</p>
        </div>
      </div>

      <!-- ğŸš€ ç°ä»£åŒ–æ€»è§ˆæ¨¡å¼ -->
      <div v-else-if="displayMode === 'overview'" class="h-full p-4 space-y-4 overflow-y-auto">
        <!-- ğŸ¯ é¡¶éƒ¨æ ¸å¿ƒKPIæŒ‡æ ‡åŒºåŸŸ -->
        <div class="grid grid-cols-4 gap-4">
          <!-- æ€»äº¤æ˜“é‡ -->
          <div class="group overview-kpi-card bg-gradient-to-br from-blue-500 via-blue-600 to-blue-700 rounded-2xl p-6 text-white relative overflow-hidden cursor-pointer transform hover:scale-105 transition-all duration-500 hover:shadow-2xl hover:shadow-blue-500/25">
            <!-- èƒŒæ™¯è£…é¥° -->
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-16 translate-x-16 group-hover:scale-150 transition-transform duration-700"></div>
            <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full translate-y-12 -translate-x-12 group-hover:scale-125 transition-transform duration-700"></div>

            <div class="relative z-10">
              <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-500">
                  <Target class="w-6 h-6 text-white" />
                </div>
                <div class="text-xs bg-white/20 px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  æ€»è®¡
                </div>
              </div>
              <div class="space-y-1">
                <div class="text-sm font-medium opacity-90">æ€»äº¤æ˜“é‡</div>
                <div class="text-2xl font-bold data-number">{{ formatNumber(atmData.totalTransactions + fxData.total) }}</div>
                <div class="text-xs opacity-75 flex items-center">
                  <TrendingUp class="w-3 h-3 mr-1" />
                  è¾ƒæ˜¨æ—¥ +{{ ((atmData.trend + fxData.trend) / 2).toFixed(1) }}%
                </div>
              </div>
            </div>
          </div>

          <!-- æ€»é‡‘é¢ -->
          <div class="group overview-kpi-card bg-gradient-to-br from-emerald-500 via-emerald-600 to-emerald-700 rounded-2xl p-6 text-white relative overflow-hidden cursor-pointer transform hover:scale-105 transition-all duration-500 hover:shadow-2xl hover:shadow-emerald-500/25">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-16 translate-x-16 group-hover:scale-150 transition-transform duration-700"></div>
            <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full translate-y-12 -translate-x-12 group-hover:scale-125 transition-transform duration-700"></div>

            <div class="relative z-10">
              <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-500">
                  <DollarSign class="w-6 h-6 text-white" />
                </div>
                <div class="text-xs bg-white/20 px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  æ€»è®¡
                </div>
              </div>
              <div class="space-y-1">
                <div class="text-sm font-medium opacity-90">æ€»é‡‘é¢</div>
                <div class="text-2xl font-bold data-number">{{ formatCurrency(atmData.totalAmount + fxData.sumAmount) }}</div>
                <div class="text-xs opacity-75 flex items-center">
                  <TrendingUp class="w-3 h-3 mr-1" />
                  å¹³å‡ {{ formatCurrency((atmData.avgAmount + fxData.avgAmount) / 2) }}
                </div>
              </div>
            </div>
          </div>

          <!-- ATMä¸šåŠ¡å æ¯” -->
          <div class="group overview-kpi-card bg-gradient-to-br from-purple-500 via-purple-600 to-purple-700 rounded-2xl p-6 text-white relative overflow-hidden cursor-pointer transform hover:scale-105 transition-all duration-500 hover:shadow-2xl hover:shadow-purple-500/25">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-16 translate-x-16 group-hover:scale-150 transition-transform duration-700"></div>
            <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full translate-y-12 -translate-x-12 group-hover:scale-125 transition-transform duration-700"></div>

            <div class="relative z-10">
              <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-500">
                  <CreditCard class="w-6 h-6 text-white" />
                </div>
                <div class="text-xs bg-white/20 px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  ATM
                </div>
              </div>
              <div class="space-y-1">
                <div class="text-sm font-medium opacity-90">ATMä¸šåŠ¡</div>
                <div class="text-2xl font-bold data-number">{{ atmData.percentage }}%</div>
                <div class="text-xs opacity-75 flex items-center">
                  <TrendingUp v-if="atmData.trend > 0" class="w-3 h-3 mr-1" />
                  <TrendingDown v-else class="w-3 h-3 mr-1" />
                  {{ atmData.trend > 0 ? '+' : '' }}{{ atmData.trend.toFixed(1) }}%
                </div>
              </div>
            </div>
          </div>

          <!-- FXä¸šåŠ¡å æ¯” -->
          <div class="group overview-kpi-card bg-gradient-to-br from-orange-500 via-orange-600 to-orange-700 rounded-2xl p-6 text-white relative overflow-hidden cursor-pointer transform hover:scale-105 transition-all duration-500 hover:shadow-2xl hover:shadow-orange-500/25">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-16 translate-x-16 group-hover:scale-150 transition-transform duration-700"></div>
            <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full translate-y-12 -translate-x-12 group-hover:scale-125 transition-transform duration-700"></div>

            <div class="relative z-10">
              <div class="flex items-center justify-between mb-3">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-500">
                  <Globe class="w-6 h-6 text-white" />
                </div>
                <div class="text-xs bg-white/20 px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  FX
                </div>
              </div>
              <div class="space-y-1">
                <div class="text-sm font-medium opacity-90">å¤–æ±‡ä¸šåŠ¡</div>
                <div class="text-2xl font-bold data-number">{{ fxData.percentage }}%</div>
                <div class="text-xs opacity-75 flex items-center">
                  <TrendingUp v-if="fxData.trend > 0" class="w-3 h-3 mr-1" />
                  <TrendingDown v-else class="w-3 h-3 mr-1" />
                  {{ fxData.trend > 0 ? '+' : '' }}{{ fxData.trend.toFixed(1) }}%
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ğŸ“Š ä¸­å¤®ä¸šåŠ¡åˆ†å¸ƒå¯è§†åŒ–åŒºåŸŸ -->
        <div class="bg-gradient-to-br from-white via-gray-50/50 to-blue-50/30 rounded-2xl p-6 border border-gray-100/60 shadow-lg">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h3 class="text-lg font-bold text-gray-800">ä¸šåŠ¡åˆ†å¸ƒæ¦‚è§ˆ</h3>
              <p class="text-sm text-gray-600">ATMä¸å¤–æ±‡ä¸šåŠ¡å®æ—¶æ•°æ®åˆ†æ</p>
            </div>
            <div class="flex items-center space-x-2">
              <div class="w-3 h-3 rounded-full bg-blue-500"></div>
              <span class="text-xs text-gray-600">ATM</span>
              <div class="w-3 h-3 rounded-full bg-emerald-500 ml-4"></div>
              <span class="text-xs text-gray-600">å¤–æ±‡</span>
            </div>
          </div>

          <div class="h-80 relative">
            <v-chart
              ref="mainChartRef"
              class="w-full h-full"
              :option="modernOverviewChartOption"
              :autoresize="true"
              @click="handleChartClick"
            />
          </div>
        </div>

        <!-- ğŸ”¥ åº•éƒ¨æ´å¯ŸåŒºåŸŸ -->
        <div class="grid grid-cols-3 gap-4">
          <!-- çƒ­é—¨æ’è¡Œ -->
          <div class="bg-gradient-to-br from-white via-red-50/30 to-pink-50/50 rounded-xl p-5 border border-red-100/60 shadow-md">
            <div class="flex items-center mb-4">
              <div class="w-8 h-8 bg-gradient-to-r from-red-500 to-pink-500 rounded-lg flex items-center justify-center mr-3">
                <TrendingUp class="w-4 h-4 text-white" />
              </div>
              <h4 class="font-semibold text-gray-800">çƒ­é—¨æ’è¡Œ</h4>
            </div>
            <div class="space-y-3">
              <div class="flex items-center justify-between p-2 bg-white/60 rounded-lg">
                <div class="flex items-center">
                  <div class="w-6 h-6 bg-yellow-500 rounded-full flex items-center justify-center text-xs font-bold text-white mr-2">1</div>
                  <span class="text-sm font-medium">{{ getTopCurrency() }}</span>
                </div>
                <span class="text-xs text-gray-600">çƒ­é—¨å¸ç§</span>
              </div>
              <div class="flex items-center justify-between p-2 bg-white/60 rounded-lg">
                <div class="flex items-center">
                  <div class="w-6 h-6 bg-gray-400 rounded-full flex items-center justify-center text-xs font-bold text-white mr-2">2</div>
                  <span class="text-sm font-medium">{{ getTopPurpose() }}</span>
                </div>
                <span class="text-xs text-gray-600">ä¸»è¦ç›®çš„</span>
              </div>
              <div class="flex items-center justify-between p-2 bg-white/60 rounded-lg">
                <div class="flex items-center">
                  <div class="w-6 h-6 bg-orange-400 rounded-full flex items-center justify-center text-xs font-bold text-white mr-2">3</div>
                  <span class="text-sm font-medium">{{ getTopProvince() }}</span>
                </div>
                <span class="text-xs text-gray-600">æ´»è·ƒçœä»½</span>
              </div>
            </div>
          </div>

          <!-- è¶‹åŠ¿åˆ†æ -->
          <div class="bg-gradient-to-br from-white via-green-50/30 to-emerald-50/50 rounded-xl p-5 border border-green-100/60 shadow-md">
            <div class="flex items-center mb-4">
              <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-500 rounded-lg flex items-center justify-center mr-3">
                <BarChart3 class="w-4 h-4 text-white" />
              </div>
              <h4 class="font-semibold text-gray-800">è¶‹åŠ¿åˆ†æ</h4>
            </div>
            <div class="space-y-3">
              <div class="p-3 bg-white/60 rounded-lg">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-sm font-medium">ATMä¸šåŠ¡</span>
                  <div class="flex items-center">
                    <TrendingUp v-if="atmData.trend > 0" class="w-4 h-4 text-green-500 mr-1" />
                    <TrendingDown v-else class="w-4 h-4 text-red-500 mr-1" />
                    <span class="text-sm font-bold" :class="atmData.trend > 0 ? 'text-green-600' : 'text-red-600'">
                      {{ atmData.trend > 0 ? '+' : '' }}{{ atmData.trend.toFixed(1) }}%
                    </span>
                  </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-blue-500 h-2 rounded-full transition-all duration-1000" :style="{ width: `${Math.min(Math.abs(atmData.trend) * 10, 100)}%` }"></div>
                </div>
              </div>
              <div class="p-3 bg-white/60 rounded-lg">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-sm font-medium">å¤–æ±‡ä¸šåŠ¡</span>
                  <div class="flex items-center">
                    <TrendingUp v-if="fxData.trend > 0" class="w-4 h-4 text-green-500 mr-1" />
                    <TrendingDown v-else class="w-4 h-4 text-red-500 mr-1" />
                    <span class="text-sm font-bold" :class="fxData.trend > 0 ? 'text-green-600' : 'text-red-600'">
                      {{ fxData.trend > 0 ? '+' : '' }}{{ fxData.trend.toFixed(1) }}%
                    </span>
                  </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-emerald-500 h-2 rounded-full transition-all duration-1000" :style="{ width: `${Math.min(Math.abs(fxData.trend) * 10, 100)}%` }"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- åœ°åŸŸåˆ†å¸ƒ -->
          <div class="bg-gradient-to-br from-white via-blue-50/30 to-cyan-50/50 rounded-xl p-5 border border-blue-100/60 shadow-md">
            <div class="flex items-center mb-4">
              <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center mr-3">
                <MapPin class="w-4 h-4 text-white" />
              </div>
              <h4 class="font-semibold text-gray-800">åœ°åŸŸåˆ†å¸ƒ</h4>
            </div>
            <div class="space-y-2">
              <div class="flex items-center justify-between text-sm">
                <span>æ´»è·ƒçœä»½</span>
                <span class="font-bold text-blue-600">{{ (atmData.provinceData.length + fxData.provinceData.length) }}</span>
              </div>
              <div class="flex items-center justify-between text-sm">
                <span>ATMè¦†ç›–</span>
                <span class="font-bold text-blue-600">{{ atmData.provinceData.length }}</span>
              </div>
              <div class="flex items-center justify-between text-sm">
                <span>FXè¦†ç›–</span>
                <span class="font-bold text-emerald-600">{{ fxData.provinceData.length }}</span>
              </div>
              <div class="mt-3 p-2 bg-white/60 rounded-lg">
                <div class="text-xs text-gray-600 mb-1">è¦†ç›–ç‡</div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-gradient-to-r from-blue-500 to-emerald-500 h-2 rounded-full transition-all duration-1000" style="width: 85%"></div>
                </div>
                <div class="text-xs text-gray-600 mt-1 text-right">85%</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- è¯¦ç»†åˆ†ææ¨¡å¼ -->
      <div v-else-if="displayMode === 'detailed'" class="h-full p-4">
        <!-- å…¨éƒ¨ä¸šåŠ¡ï¼šæ˜¾ç¤ºATMå’ŒFXçš„è¯¦ç»†å¯¹æ¯” -->
        <div v-if="selectedBusinessType === 'all'" class="grid grid-cols-2 gap-4 max-h-96">
          <!-- ATMä¸šåŠ¡è¯¦ç»†åˆ†æ -->
          <div class="bg-background rounded-lg p-4 border h-80">
            <h4 class="font-semibold text-sm mb-3 flex items-center">
              <CreditCard class="w-4 h-4 mr-2 text-blue-500" />
              ATMä¸šåŠ¡åˆ†æ
            </h4>
            <div class="h-56">
              <v-chart
                ref="atmDetailChartRef"
                class="w-full h-full"
                :option="atmDetailChartOption"
                :autoresize="true"
              />
            </div>
            <!-- ATMä¸šåŠ¡æ•°æ®æ‘˜è¦ -->
            <div class="mt-2 text-xs text-gray-600">
              <div class="flex justify-between">
                <span>çœä»½æ•°é‡:</span>
                <span>{{ atmData.provinceData.length }}</span>
              </div>
              <div class="flex justify-between">
                <span>é‡‘é¢æ¡£æ¬¡:</span>
                <span>{{ atmData.amountDistribution.length }}</span>
              </div>
            </div>
          </div>

          <!-- FXå¤–æ±‡ä¸šåŠ¡è¯¦ç»†åˆ†æ -->
          <div class="bg-background rounded-lg p-4 border h-80">
            <h4 class="font-semibold text-sm mb-3 flex items-center">
              <DollarSign class="w-4 h-4 mr-2 text-green-500" />
              å¤–æ±‡ä¸šåŠ¡åˆ†æ
            </h4>
            <div class="h-56">
              <v-chart
                ref="fxDetailChartRef"
                class="w-full h-full"
                :option="fxDetailChartOption"
                :autoresize="true"
              />
            </div>
            <!-- FXä¸šåŠ¡æ•°æ®æ‘˜è¦ -->
            <div class="mt-2 text-xs text-gray-600">
              <div class="flex justify-between">
                <span>çƒ­é—¨å¸ç§:</span>
                <span>{{ getTopCurrency() }}</span>
              </div>
              <div class="flex justify-between">
                <span>ä¸»è¦ç›®çš„:</span>
                <span>{{ getTopPurpose() }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ATMä¸šåŠ¡ï¼šæ˜¾ç¤ºATMä¸“å±çš„å¤šç»´åº¦åˆ†æ -->
        <div v-else-if="selectedBusinessType === 'atm'" class="space-y-4">
          <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šçœä»½åˆ†å¸ƒå’Œé‡‘é¢åˆ†å¸ƒ -->
          <div class="grid grid-cols-2 gap-4">
            <!-- ATMçœä»½åˆ†å¸ƒ -->
            <div class="bg-background rounded-lg p-4 border h-72">
              <h4 class="font-semibold text-sm mb-3 flex items-center">
                <MapPin class="w-4 h-4 mr-2 text-blue-500" />
                çœä»½åˆ†å¸ƒåˆ†æ
              </h4>
              <div class="h-52">
                <v-chart
                  class="w-full h-full"
                  :option="atmProvinceChartOption"
                  :autoresize="true"
                />
              </div>
            </div>

            <!-- ATMé‡‘é¢åˆ†å¸ƒ -->
            <div class="bg-background rounded-lg p-4 border h-72">
              <h4 class="font-semibold text-sm mb-3 flex items-center">
                <CreditCard class="w-4 h-4 mr-2 text-blue-500" />
                é‡‘é¢åˆ†å¸ƒåˆ†æ
              </h4>
              <div class="h-52">
                <v-chart
                  ref="atmDetailChartRef"
                  class="w-full h-full"
                  :option="atmDetailChartOption"
                  :autoresize="true"
                />
              </div>
            </div>
          </div>

          <!-- ä¸‹åŠéƒ¨åˆ†ï¼šå…³é”®æŒ‡æ ‡å¡ç‰‡ -->
          <div class="grid grid-cols-5 gap-4">
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-xs text-blue-600 font-medium">æ€»äº¤æ˜“é‡</div>
                  <div class="text-lg font-bold text-blue-700">{{ formatNumber(atmData.totalTransactions) }}</div>
                </div>
                <div class="w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center">
                  <Target class="w-4 h-4 text-blue-600" />
                </div>
              </div>
            </div>

            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-xs text-blue-600 font-medium">æ€»é‡‘é¢</div>
                  <div class="text-lg font-bold text-blue-700">{{ formatCurrency(atmData.totalAmount) }}</div>
                </div>
                <div class="w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center">
                  <DollarSign class="w-4 h-4 text-blue-600" />
                </div>
              </div>
            </div>

            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-xs text-blue-600 font-medium">å¹³å‡é‡‘é¢</div>
                  <div class="text-lg font-bold text-blue-700">{{ formatCurrency(atmData.avgAmount) }}</div>
                </div>
                <div class="w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center">
                  <CreditCard class="w-4 h-4 text-blue-600" />
                </div>
              </div>
            </div>

            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-xs text-blue-600 font-medium">æ´»è·ƒçœä»½</div>
                  <div class="text-lg font-bold text-blue-700">{{ atmData.provinceData.length }}</div>
                </div>
                <div class="w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center">
                  <MapPin class="w-4 h-4 text-blue-600" />
                </div>
              </div>
            </div>

            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-xs text-blue-600 font-medium">å¢é•¿ç‡</div>
                  <div class="text-lg font-bold" :class="atmData.trend > 0 ? 'text-green-600' : 'text-red-600'">
                    {{ atmData.trend > 0 ? '+' : '' }}{{ atmData.trend.toFixed(1) }}%
                  </div>
                </div>
                <div class="w-8 h-8 bg-blue-500/20 rounded-full flex items-center justify-center">
                  <TrendingUp v-if="atmData.trend > 0" class="w-4 h-4 text-green-600" />
                  <TrendingDown v-else class="w-4 h-4 text-red-600" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- FXä¸šåŠ¡ï¼šæ˜¾ç¤ºFXä¸“å±çš„å¤šç»´åº¦åˆ†æ -->
        <div v-else class="space-y-4 h-full overflow-y-auto">
          <!-- ç¬¬ä¸€è¡Œï¼šç›®çš„åˆ†å¸ƒã€å¸ç§åˆ†å¸ƒã€å¹´é¾„åˆ†å¸ƒ -->
          <div class="grid grid-cols-3 gap-4">
            <!-- FXç›®çš„åˆ†å¸ƒ -->
            <div class="group bg-gradient-to-br from-white via-green-50/30 to-emerald-50/50 rounded-xl p-4 border border-green-100/60 h-88 hover:shadow-xl hover:shadow-green-500/10 transition-all duration-500 hover:-translate-y-2 cursor-pointer relative overflow-hidden">
              <!-- èƒŒæ™¯è£…é¥° -->
              <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-green-400/10 to-emerald-400/10 rounded-full -translate-y-10 translate-x-10 group-hover:scale-150 transition-transform duration-700"></div>

              <div class="flex items-center justify-between mb-3 relative z-10">
                <h4 class="font-semibold text-sm flex items-center text-gray-700">
                  <div class="w-9 h-9 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 group-hover:rotate-3 transition-all duration-300 shadow-lg">
                    <Target class="w-4 h-4 text-white" />
                  </div>
                  <span class="group-hover:text-green-700 transition-colors duration-300">äº¤æ˜“ç›®çš„åˆ†æ</span>
                </h4>
                <div class="text-xs text-green-600 bg-green-100/80 backdrop-blur-sm px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-x-2 group-hover:translate-x-0">
                  ç‚¹å‡»äº¤äº’
                </div>
              </div>

              <div class="h-69 relative overflow-hidden rounded-xl bg-white/50 backdrop-blur-sm border border-green-100/50">
                <v-chart
                  ref="fxDetailChartRef"
                  class="w-full h-full transition-all duration-500 group-hover:scale-105"
                  :option="fxDetailChartOption"
                  :autoresize="true"
                  @click="handleChartClick"
                />
                <!-- æ‚¬æµ®é®ç½© -->
                <div class="absolute inset-0 bg-gradient-to-t from-green-500/5 via-transparent to-emerald-500/5 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
              </div>
            </div>

            <!-- FXå¸ç§åˆ†å¸ƒ -->
            <div class="group bg-gradient-to-br from-white via-blue-50/30 to-cyan-50/50 rounded-xl p-4 border border-blue-100/60 h-88 hover:shadow-xl hover:shadow-blue-500/10 transition-all duration-500 hover:-translate-y-2 cursor-pointer relative overflow-hidden">
              <!-- èƒŒæ™¯è£…é¥° -->
              <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-blue-400/10 to-cyan-400/10 rounded-full -translate-y-10 translate-x-10 group-hover:scale-150 transition-transform duration-700"></div>

              <div class="flex items-center justify-between mb-3 relative z-10">
                <h4 class="font-semibold text-sm flex items-center text-gray-700">
                  <div class="w-9 h-9 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 group-hover:rotate-3 transition-all duration-300 shadow-lg">
                    <DollarSign class="w-4 h-4 text-white" />
                  </div>
                  <span class="group-hover:text-blue-700 transition-colors duration-300">å¸ç§åˆ†å¸ƒåˆ†æ</span>
                </h4>
                <div class="text-xs text-blue-600 bg-blue-100/80 backdrop-blur-sm px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-x-2 group-hover:translate-x-0">
                  ç‚¹å‡»äº¤äº’
                </div>
              </div>

              <div class="h-69 relative overflow-hidden rounded-xl bg-white/50 backdrop-blur-sm border border-blue-100/50">
                <v-chart
                  class="w-full h-full transition-all duration-500 group-hover:scale-105"
                  :option="fxKindChartOption"
                  :autoresize="true"
                  @click="handleChartClick"
                />
                <!-- æ‚¬æµ®é®ç½© -->
                <div class="absolute inset-0 bg-gradient-to-t from-blue-500/5 via-transparent to-cyan-500/5 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
              </div>
            </div>

            <!-- FXå¹´é¾„åˆ†å¸ƒ -->
            <div class="group bg-gradient-to-br from-white via-purple-50/30 to-pink-50/50 rounded-xl p-4 border border-purple-100/60 h-88 hover:shadow-xl hover:shadow-purple-500/10 transition-all duration-500 hover:-translate-y-2 cursor-pointer relative overflow-hidden">
              <!-- èƒŒæ™¯è£…é¥° -->
              <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-purple-400/10 to-pink-400/10 rounded-full -translate-y-10 translate-x-10 group-hover:scale-150 transition-transform duration-700"></div>

              <div class="flex items-center justify-between mb-3 relative z-10">
                <h4 class="font-semibold text-sm flex items-center text-gray-700">
                  <div class="w-9 h-9 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 group-hover:rotate-3 transition-all duration-300 shadow-lg">
                    <TrendingUp class="w-4 h-4 text-white" />
                  </div>
                  <span class="group-hover:text-purple-700 transition-colors duration-300">å¹´é¾„åˆ†å¸ƒåˆ†æ</span>
                </h4>
                <div class="text-xs text-purple-600 bg-purple-100/80 backdrop-blur-sm px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-x-2 group-hover:translate-x-0">
                  ç‚¹å‡»äº¤äº’
                </div>
              </div>

              <div class="h-69 relative overflow-hidden rounded-xl bg-white/50 backdrop-blur-sm border border-purple-100/50">
                <v-chart
                  class="w-full h-full transition-all duration-500 group-hover:scale-105"
                  :option="fxAgeChartOption"
                  :autoresize="true"
                  @click="handleChartClick"
                />
                <!-- æ‚¬æµ®é®ç½© -->
                <div class="absolute inset-0 bg-gradient-to-t from-purple-500/5 via-transparent to-pink-500/5 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
              </div>
            </div>
          </div>

          <!-- ç¬¬äºŒè¡Œï¼šFXä¸“å±å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
          <div class="grid grid-cols-4 gap-4">
            <!-- FXæ€»äº¤æ˜“é‡å¡ç‰‡ -->
            <div class="group bg-gradient-to-br from-white via-green-50/40 to-emerald-50/60 rounded-xl p-4 border border-green-100/60 hover:shadow-lg hover:shadow-green-500/10 transition-all duration-300 hover:-translate-y-1 cursor-pointer relative overflow-hidden">
              <div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-br from-green-400/5 to-emerald-400/5 rounded-full -translate-y-8 translate-x-8 group-hover:scale-125 transition-transform duration-500"></div>

              <div class="flex items-center justify-between relative z-10">
                <div>
                  <div class="text-xs text-green-600 font-medium mb-1 group-hover:text-green-700 transition-colors duration-300">FXæ€»äº¤æ˜“é‡</div>
                  <div class="text-lg font-bold text-green-700 group-hover:text-green-800 transition-colors duration-300">{{ formatNumber(fxData.total) }}</div>
                  <div class="text-xs text-green-500 mt-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
                <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl flex items-center justify-center group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 shadow-lg">
                  <Target class="w-5 h-5 text-white" />
                </div>
              </div>
            </div>

            <!-- FXæ€»é‡‘é¢å¡ç‰‡ -->
            <div class="group bg-gradient-to-br from-white via-blue-50/40 to-cyan-50/60 rounded-xl p-4 border border-blue-100/60 hover:shadow-lg hover:shadow-blue-500/10 transition-all duration-300 hover:-translate-y-1 cursor-pointer relative overflow-hidden">
              <div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-br from-blue-400/5 to-cyan-400/5 rounded-full -translate-y-8 translate-x-8 group-hover:scale-125 transition-transform duration-500"></div>

              <div class="flex items-center justify-between relative z-10">
                <div>
                  <div class="text-xs text-blue-600 font-medium mb-1 group-hover:text-blue-700 transition-colors duration-300">FXæ€»é‡‘é¢</div>
                  <div class="text-lg font-bold text-blue-700 group-hover:text-blue-800 transition-colors duration-300">{{ formatCurrency(fxData.sumAmount) }}</div>
                  <div class="text-xs text-blue-500 mt-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
                <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 shadow-lg">
                  <DollarSign class="w-5 h-5 text-white" />
                </div>
              </div>
            </div>

            <!-- çƒ­é—¨å¸ç§å¡ç‰‡ -->
            <div class="group bg-gradient-to-br from-white via-purple-50/40 to-pink-50/60 rounded-xl p-4 border border-purple-100/60 hover:shadow-lg hover:shadow-purple-500/10 transition-all duration-300 hover:-translate-y-1 cursor-pointer relative overflow-hidden">
              <div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-br from-purple-400/5 to-pink-400/5 rounded-full -translate-y-8 translate-x-8 group-hover:scale-125 transition-transform duration-500"></div>

              <div class="flex items-center justify-between relative z-10">
                <div>
                  <div class="text-xs text-purple-600 font-medium mb-1 group-hover:text-purple-700 transition-colors duration-300">çƒ­é—¨å¸ç§</div>
                  <div class="text-lg font-bold text-purple-700 group-hover:text-purple-800 transition-colors duration-300">{{ getTopCurrency() }}</div>
                  <div class="text-xs text-purple-500 mt-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
                <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 shadow-lg">
                  <CreditCard class="w-5 h-5 text-white" />
                </div>
              </div>
            </div>

            <!-- ä¸»è¦ç›®çš„å¡ç‰‡ -->
            <div class="group bg-gradient-to-br from-white via-orange-50/40 to-amber-50/60 rounded-xl p-4 border border-orange-100/60 hover:shadow-lg hover:shadow-orange-500/10 transition-all duration-300 hover:-translate-y-1 cursor-pointer relative overflow-hidden">
              <div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-br from-orange-400/5 to-amber-400/5 rounded-full -translate-y-8 translate-x-8 group-hover:scale-125 transition-transform duration-500"></div>

              <div class="flex items-center justify-between relative z-10">
                <div>
                  <div class="text-xs text-orange-600 font-medium mb-1 group-hover:text-orange-700 transition-colors duration-300">ä¸»è¦ç›®çš„</div>
                  <div class="text-lg font-bold text-orange-700 group-hover:text-orange-800 transition-colors duration-300">{{ getTopPurpose() }}</div>
                  <div class="text-xs text-orange-500 mt-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
                <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-amber-500 rounded-xl flex items-center justify-center group-hover:scale-110 group-hover:rotate-6 transition-all duration-300 shadow-lg">
                  <MapPin class="w-5 h-5 text-white" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- å¯¹æ¯”åˆ†ææ¨¡å¼ -->
      <div v-else class="h-full p-4 flex flex-col">
        <!-- å…¨éƒ¨ä¸šåŠ¡ï¼šATM vs FX å¯¹æ¯”åˆ†æ -->
        <div v-if="selectedBusinessType === 'all'">
          <!-- å¯¹æ¯”åˆ†ææ ‡é¢˜ -->
          <div class="mb-4">
            <h4 class="font-semibold text-sm text-gray-700">ä¸šåŠ¡ç±»å‹å¯¹æ¯”åˆ†æ</h4>
            <p class="text-xs text-gray-500">ATMä¸å¤–æ±‡ä¸šåŠ¡å…³é”®æŒ‡æ ‡å¯¹æ¯”</p>
          </div>

          <!-- å›¾è¡¨å®¹å™¨ - å›ºå®šé«˜åº¦ -->
          <div class="h-80 w-full">
            <v-chart
              ref="comparisonChartRef"
              class="w-full h-full"
              :option="comparisonChartOption"
              :autoresize="true"
              @click="handleChartClick"
            />
          </div>

          <!-- å¯¹æ¯”æ•°æ®è¡¨æ ¼ -->
          <div class="mt-4 bg-gray-50 rounded-lg p-4">
            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-2">
                <h5 class="font-medium text-sm text-blue-600">ATMä¸šåŠ¡</h5>
                <div class="space-y-1 text-xs">
                  <div class="flex justify-between">
                    <span>äº¤æ˜“ç¬”æ•°:</span>
                    <span class="font-medium">{{ formatNumber(atmData.totalTransactions) }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span>æ€»é‡‘é¢:</span>
                    <span class="font-medium">{{ formatCurrency(atmData.totalAmount) }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span>å¹³å‡é‡‘é¢:</span>
                    <span class="font-medium">{{ formatCurrency(atmData.avgAmount) }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span>å¢é•¿ç‡:</span>
                    <span class="font-medium" :class="atmData.trend > 0 ? 'text-green-600' : 'text-red-600'">
                      {{ atmData.trend > 0 ? '+' : '' }}{{ atmData.trend.toFixed(1) }}%
                    </span>
                  </div>
                </div>
              </div>

              <div class="space-y-2">
                <h5 class="font-medium text-sm text-green-600">å¤–æ±‡ä¸šåŠ¡</h5>
                <div class="space-y-1 text-xs">
                  <div class="flex justify-between">
                    <span>äº¤æ˜“ç¬”æ•°:</span>
                    <span class="font-medium">{{ formatNumber(fxData.total) }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span>æ€»é‡‘é¢:</span>
                    <span class="font-medium">{{ formatCurrency(fxData.sumAmount) }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span>å¹³å‡é‡‘é¢:</span>
                    <span class="font-medium">{{ formatCurrency(fxData.avgAmount) }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span>å¢é•¿ç‡:</span>
                    <span class="font-medium" :class="fxData.trend > 0 ? 'text-green-600' : 'text-red-600'">
                      {{ fxData.trend > 0 ? '+' : '' }}{{ fxData.trend.toFixed(1) }}%
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ATMä¸šåŠ¡ï¼šçœä»½ vs é‡‘é¢åˆ†å¸ƒå¯¹æ¯” -->
        <div v-else-if="selectedBusinessType === 'atm'">
          <!-- å¯¹æ¯”åˆ†ææ ‡é¢˜ -->
          <div class="mb-4">
            <h4 class="font-semibold text-sm text-gray-700">ATMä¸šåŠ¡å¯¹æ¯”åˆ†æ</h4>
            <p class="text-xs text-gray-500">çœä»½åˆ†å¸ƒä¸é‡‘é¢åˆ†å¸ƒå¯¹æ¯”</p>
          </div>

          <!-- å›¾è¡¨å®¹å™¨ -->
          <div class="h-80 w-full">
            <v-chart
              class="w-full h-full"
              :option="atmComparisonChartOption"
              :autoresize="true"
            />
          </div>

          <!-- ATMå¯¹æ¯”æ•°æ®è¡¨æ ¼ -->
          <div class="mt-4 bg-gray-50 rounded-lg p-4">
            <div class="grid grid-cols-3 gap-4">
              <div class="space-y-2">
                <h5 class="font-medium text-sm text-blue-600">çœä»½åˆ†æ</h5>
                <div class="space-y-1 text-xs">
                  <div class="flex justify-between">
                    <span>æ´»è·ƒçœä»½:</span>
                    <span class="font-medium">{{ atmData.provinceData.length }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span>æœ€é«˜äº¤æ˜“:</span>
                    <span class="font-medium">{{ getTopAtmProvince() }}</span>
                  </div>
                </div>
              </div>
              <div class="space-y-2">
                <h5 class="font-medium text-sm text-blue-600">é‡‘é¢åˆ†æ</h5>
                <div class="space-y-1 text-xs">
                  <div class="flex justify-between">
                    <span>é‡‘é¢æ¡£æ¬¡:</span>
                    <span class="font-medium">{{ atmData.amountDistribution.length }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span>ä¸»è¦æ¡£æ¬¡:</span>
                    <span class="font-medium">{{ getTopAtmAmount() }}</span>
                  </div>
                </div>
              </div>
              <div class="space-y-2">
                <h5 class="font-medium text-sm text-blue-600">æ€»ä½“æŒ‡æ ‡</h5>
                <div class="space-y-1 text-xs">
                  <div class="flex justify-between">
                    <span>æ€»äº¤æ˜“é‡:</span>
                    <span class="font-medium">{{ formatNumber(atmData.totalTransactions) }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span>å¢é•¿ç‡:</span>
                    <span class="font-medium" :class="atmData.trend > 0 ? 'text-green-600' : 'text-red-600'">
                      {{ atmData.trend > 0 ? '+' : '' }}{{ atmData.trend.toFixed(1) }}%
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- FXä¸šåŠ¡ï¼šå¯¹æ¯”åˆ†ææ¨¡å¼ä¸å¯ç”¨ -->
        <div v-else class="h-full flex items-center justify-center">
          <div class="text-center space-y-4">
            <div class="w-16 h-16 mx-auto bg-gray-100 rounded-full flex items-center justify-center">
              <DollarSign class="w-8 h-8 text-gray-400" />
            </div>
            <div>
              <h4 class="font-medium text-gray-700 mb-2">FXä¸šåŠ¡å¯¹æ¯”åˆ†æ</h4>
              <p class="text-sm text-gray-500 mb-4">å¤–æ±‡ä¸šåŠ¡æš‚ä¸æ”¯æŒå¯¹æ¯”åˆ†ææ¨¡å¼</p>
              <p class="text-xs text-gray-400">è¯·é€‰æ‹©"æ€»è§ˆ"æˆ–"è¯¦ç»†åˆ†æ"æ¨¡å¼æŸ¥çœ‹FXä¸šåŠ¡æ•°æ®</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ•°æ®ç»Ÿè®¡å¡ç‰‡ - ç´§å‡‘å¸ƒå±€ (åœ¨FXä¸“é¡¹æ¨¡å¼ä¸‹éšè—) -->
    <div v-if="!(selectedBusinessType === 'fx' && (displayMode === 'detailed' || displayMode === 'comparison'))" class="grid grid-cols-4 gap-2 mt-3">
      <div class="bg-gradient-to-r from-blue-500/10 to-blue-600/10 rounded-lg p-2 border border-blue-200/50">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-blue-600 font-medium">æ€»ä¸šåŠ¡é‡</p>
            <p class="text-sm font-bold text-blue-700">{{ formatNumber(totalBusinessCount) }}</p>
          </div>
          <div class="w-6 h-6 bg-blue-500/20 rounded-full flex items-center justify-center">
            <Target class="w-3 h-3 text-blue-600" />
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-r from-green-500/10 to-green-600/10 rounded-lg p-2 border border-green-200/50">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-green-600 font-medium">ATMå æ¯”</p>
            <p class="text-sm font-bold text-green-700">{{ atmData.percentage }}%</p>
          </div>
          <div class="w-6 h-6 bg-green-500/20 rounded-full flex items-center justify-center">
            <CreditCard class="w-3 h-3 text-green-600" />
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-r from-orange-500/10 to-orange-600/10 rounded-lg p-2 border border-orange-200/50">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-orange-600 font-medium">FXå æ¯”</p>
            <p class="text-sm font-bold text-orange-700">{{ fxData.percentage }}%</p>
          </div>
          <div class="w-6 h-6 bg-orange-500/20 rounded-full flex items-center justify-center">
            <DollarSign class="w-3 h-3 text-orange-600" />
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-r from-purple-500/10 to-purple-600/10 rounded-lg p-2 border border-purple-200/50">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-purple-600 font-medium">æ´»è·ƒçœä»½</p>
            <p class="text-sm font-bold text-purple-700">{{ activeProvinces }}</p>
          </div>
          <div class="w-6 h-6 bg-purple-500/20 rounded-full flex items-center justify-center">
            <MapPin class="w-3 h-3 text-purple-600" />
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted, watch } from 'vue'
import {
  RefreshCw,
  TrendingUp,
  TrendingDown,
  Target,
  CreditCard,
  DollarSign,
  MapPin,
  Globe,
  BarChart3
} from 'lucide-vue-next'
import { Button } from '@/components/ui/button'
import { use } from 'echarts/core'
import { CanvasRenderer } from 'echarts/renderers'
import { PieChart, BarChart, LineChart } from 'echarts/charts'
import {
  TitleComponent,
  TooltipComponent,
  LegendComponent,
  GridComponent
} from 'echarts/components'
import VChart from 'vue-echarts'

// æ³¨å†ŒEChartsç»„ä»¶
use([
  CanvasRenderer,
  PieChart,
  BarChart,
  LineChart,
  TitleComponent,
  TooltipComponent,
  LegendComponent,
  GridComponent
])

/**
 * ç»„ä»¶å±æ€§å®šä¹‰
 */
interface Props {
  title?: string
  subtitle?: string
  chartHeight?: string
  autoRefresh?: boolean
  refreshInterval?: number
}

const props = withDefaults(defineProps<Props>(), {
  title: 'ä¸šåŠ¡ç±»å‹åˆ†å¸ƒç»Ÿè®¡',
  subtitle: 'ATMä¸å¤–æ±‡ä¸šåŠ¡æ•°æ®åˆ†æ',
  chartHeight: "calc(100vh - 200px)",
  autoRefresh: true,
  refreshInterval: 30000
})

/**
 * å“åº”å¼æ•°æ®
 */
const selectedBusinessType = ref<'all' | 'atm' | 'fx'>('all')
const displayMode = ref<'overview' | 'detailed' | 'comparison'>('overview')
const isLoading = ref(false)
const chartContainer = ref<HTMLElement | null>(null)
const mainChartRef = ref<InstanceType<typeof VChart> | null>(null)
const atmDetailChartRef = ref<InstanceType<typeof VChart> | null>(null)
const fxDetailChartRef = ref<InstanceType<typeof VChart> | null>(null)
const comparisonChartRef = ref<InstanceType<typeof VChart> | null>(null)

// ä¸šåŠ¡æ•°æ®æ¥å£ - æ ¹æ®MySQLè¡¨ç»“æ„å®šä¹‰
interface ATMData {
  // åŸºç¡€ç»Ÿè®¡
  totalTransactions: number
  totalAmount: number
  avgAmount: number
  percentage: number
  trend: number

  // çœä»½åˆ†å¸ƒæ•°æ® (æ¥è‡ª atm_dist_province)
  provinceData: Array<{
    province: string
    transcation_times: number
    sum_amount: number
  }>

  // é‡‘é¢åˆ†å¸ƒæ•°æ® (æ¥è‡ª atm_dist_amount)
  amountDistribution: Array<{
    amountLevel: string
    total: number
  }>

  // KPIæ•°æ® (æ¥è‡ª atm_minute_kpi)
  kpiData: Array<{
    time_stamp: string
    total_time: number
    total_amount: number
    total: number
  }>
}

interface FXData {
  // åŸºç¡€ç»Ÿè®¡ (total:æ€»äº¤æ˜“ç¬”æ•°   sumAmountï¼šæ€»äº¤æ˜“é‡‘é¢    avgAmountï¼šå¹³å‡äº¤æ˜“é‡‘é¢     percentageï¼šäº¤æ˜“ç¬”æ•°å æ¯”     trendï¼šäº¤æ˜“ç¬”æ•°å¢é•¿ç‡)
  total: number
  sumAmount: number
  avgAmount: number
  percentage: number
  trend: number

  // çœä»½åˆ†å¸ƒæ•°æ® (æ¥è‡ª fx_dist_province)
  provinceData: Array<{
    province: string
    total: number
    sum_amount: number
  }>

  // ç›®çš„åˆ†å¸ƒæ•°æ® (æ¥è‡ª fx_dist_purpose)
  purposeData: Array<{
    purpose: string
    total: number
  }>

  // å¸ç§åˆ†å¸ƒæ•°æ® (æ¥è‡ª fx_dist_kind)
  kindData: Array<{
    kind: string
    total: number
  }>

  // å¹´é¾„åˆ†å¸ƒæ•°æ® (æ¥è‡ª fx_dist_age)
  ageData: Array<{
    ageLevel: string
    total: number
  }>

  // KPIæ•°æ® (æ¥è‡ª fx_minute_kpi)
  kpiData: Array<{
    time_stamp: string
    total_time: number
    total_amount: number
    total: number
  }>
}

// ATMä¸šåŠ¡æ•°æ® - ä½¿ç”¨ä¸°å¯Œçš„æ¨¡æ‹Ÿæ•°æ®å±•ç¤ºè¯¦ç»†åˆ†ææ•ˆæœ
const atmData = ref<ATMData>({
  totalTransactions: 18650,
  totalAmount: 285600000,
  avgAmount: 15310,
  percentage: 72.3,
  trend: 6.8,
  // æ›´å¤šçœä»½æ•°æ®ï¼Œå±•ç¤ºæ›´å¥½çš„åˆ†å¸ƒæ•ˆæœ
  provinceData: [
    { province: 'åŒ—äº¬', transcation_times: 3200, sum_amount: 48500000 },
    { province: 'ä¸Šæµ·', transcation_times: 2850, sum_amount: 42800000 },
    { province: 'å¹¿ä¸œ', transcation_times: 3800, sum_amount: 55200000 },
    { province: 'æ±Ÿè‹', transcation_times: 2400, sum_amount: 35600000 },
    { province: 'æµ™æ±Ÿ', transcation_times: 2100, sum_amount: 31200000 },
    { province: 'å±±ä¸œ', transcation_times: 1950, sum_amount: 28900000 },
    { province: 'å››å·', transcation_times: 1650, sum_amount: 24800000 },
    { province: 'æ²³å—', transcation_times: 1400, sum_amount: 20600000 }
  ],
  // æ›´è¯¦ç»†çš„é‡‘é¢åˆ†å¸ƒï¼Œå±•ç¤ºæ›´çœŸå®çš„æ•°æ®
  amountDistribution: [
    { amountLevel: '500ä»¥ä¸‹', total: 3200 },
    { amountLevel: '500-1000', total: 4800 },
    { amountLevel: '1000-3000', total: 6500 },
    { amountLevel: '3000-5000', total: 2800 },
    { amountLevel: '5000-10000', total: 1200 },
    { amountLevel: '10000-20000', total: 150 }
  ],
  kpiData: []
})

// FXå¤–æ±‡ä¸šåŠ¡æ•°æ® - ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆä¸ATMæ•°æ®ä¿æŒä¸€è‡´çš„æ¯”ä¾‹ï¼‰
const fxData = ref<FXData>({
  total: 7150,
  sumAmount: 168400000,
  avgAmount: 23550,
  percentage: 27.7,
  trend: 4.2,
  provinceData: [
    { province: 'åŒ—äº¬', total: 1350, sum_amount: 31800000 },
    { province: 'ä¸Šæµ·', total: 1250, sum_amount: 29400000 },
    { province: 'å¹¿ä¸œ', total: 1580, sum_amount: 37200000 },
    { province: 'æ±Ÿè‹', total: 920, sum_amount: 21600000 },
    { province: 'æµ™æ±Ÿ', total: 850, sum_amount: 20000000 },
    { province: 'å±±ä¸œ', total: 680, sum_amount: 16000000 },
    { province: 'å››å·', total: 520, sum_amount: 12400000 }
  ],
  purposeData: [
    { purpose: 'æ—…æ¸¸', total: 2860 },
    { purpose: 'æŠ•èµ„', total: 2145 },
    { purpose: 'ç•™å­¦', total: 1430 },
    { purpose: 'å•†åŠ¡', total: 715 }
  ],
  kindData: [
    { kind: 'USD', total: 3220 },
    { kind: 'EUR', total: 1820 },
    { kind: 'JPY', total: 1215 },
    { kind: 'GBP', total: 895 }
  ],
  ageData: [
    { ageLevel: '18-30', total: 2145 },
    { ageLevel: '31-45', total: 3220 },
    { ageLevel: '46-60', total: 1430 },
    { ageLevel: '60+', total: 355 }
  ],
  kpiData: []
})

/**
 * è®¡ç®—å±æ€§
 */
const chartContainerStyle = computed(() => ({
  height: props.chartHeight
}))

const totalBusinessCount = computed(() => {
  return atmData.value.totalTransactions + fxData.value.total
})

const activeProvinces = computed(() => {
  // è®¡ç®—æ´»è·ƒçœä»½æ•°é‡
  const atmProvinces = new Set(atmData.value.provinceData.map(item => item.province))
  const fxProvinces = new Set(fxData.value.provinceData.map(item => item.province))
  const allProvinces = new Set([...atmProvinces, ...fxProvinces])
  return allProvinces.size
})

/**
 * ğŸš€ ç°ä»£åŒ–æ€»è§ˆå›¾è¡¨é…ç½® - æ›´ç‚«é…·çš„ä¸šåŠ¡åˆ†å¸ƒå±•ç¤º
 */
const modernOverviewChartOption = computed(() => {
  const totalTransactions = atmData.value.totalTransactions + fxData.value.total
  const atmPercentage = totalTransactions > 0 ? (atmData.value.totalTransactions / totalTransactions * 100) : 0
  const fxPercentage = totalTransactions > 0 ? (fxData.value.total / totalTransactions * 100) : 0

  return {
    backgroundColor: 'transparent',
    tooltip: {
      trigger: 'item',
      backgroundColor: 'rgba(255, 255, 255, 0.95)',
      borderColor: '#e5e7eb',
      borderWidth: 1,
      textStyle: {
        color: '#374151',
        fontSize: 12
      },
      formatter: (params: any) => {
        return `
          <div style="padding: 8px;">
            <div style="font-weight: bold; margin-bottom: 4px;">${params.name}</div>
            <div style="display: flex; align-items: center; margin-bottom: 2px;">
              <div style="width: 8px; height: 8px; background: ${params.color}; border-radius: 50%; margin-right: 6px;"></div>
              <span>äº¤æ˜“ç¬”æ•°: ${formatNumber(params.value)}</span>
            </div>
            <div>å æ¯”: ${params.percent}%</div>
          </div>
        `
      }
    },
    legend: {
      orient: 'horizontal',
      bottom: '5%',
      left: 'center',
      textStyle: {
        color: '#6b7280',
        fontSize: 12
      },
      itemWidth: 12,
      itemHeight: 12,
      itemGap: 20
    },
    series: [
      {
        name: 'ä¸šåŠ¡åˆ†å¸ƒ',
        type: 'pie',
        radius: ['45%', '75%'],
        center: ['50%', '45%'],
        avoidLabelOverlap: false,
        itemStyle: {
          borderRadius: 8,
          borderColor: '#fff',
          borderWidth: 3,
          shadowBlur: 10,
          shadowColor: 'rgba(0, 0, 0, 0.1)'
        },
        label: {
          show: true,
          position: 'outside',
          formatter: '{b}\n{d}%',
          fontSize: 12,
          fontWeight: 'bold',
          color: '#374151'
        },
        emphasis: {
          itemStyle: {
            shadowBlur: 20,
            shadowOffsetX: 0,
            shadowColor: 'rgba(0, 0, 0, 0.2)'
          },
          label: {
            show: true,
            fontSize: 14,
            fontWeight: 'bold'
          }
        },
        data: [
          {
            value: atmData.value.totalTransactions,
            name: 'ATMä¸šåŠ¡',
            itemStyle: {
              color: {
                type: 'linear',
                x: 0, y: 0, x2: 1, y2: 1,
                colorStops: [
                  { offset: 0, color: '#3b82f6' },
                  { offset: 1, color: '#1d4ed8' }
                ]
              }
            }
          },
          {
            value: fxData.value.total,
            name: 'å¤–æ±‡ä¸šåŠ¡',
            itemStyle: {
              color: {
                type: 'linear',
                x: 0, y: 0, x2: 1, y2: 1,
                colorStops: [
                  { offset: 0, color: '#10b981' },
                  { offset: 1, color: '#047857' }
                ]
              }
            }
          }
        ],
        animationType: 'scale',
        animationEasing: 'elasticOut',
        animationDelay: (idx: number) => idx * 200
      }
    ]
  }
})

/**
 * ä¸»å›¾è¡¨é…ç½® - æ ¹æ®ä¸šåŠ¡ç±»å‹æ˜¾ç¤ºä¸åŒå†…å®¹
 */
const mainChartOption = computed(() => {
  // æ ¹æ®é€‰æ‹©çš„ä¸šåŠ¡ç±»å‹æ˜¾ç¤ºä¸åŒçš„å›¾è¡¨
  if (selectedBusinessType.value === 'atm') {
    // ATMä¸šåŠ¡ï¼šæ˜¾ç¤ºçœä»½åˆ†å¸ƒ
    const data = atmData.value.provinceData.map((item, index) => ({
      name: item.province,
      value: item.transcation_times,
      itemStyle: {
        color: ['#3b82f6', '#1d4ed8', '#60a5fa', '#93c5fd', '#dbeafe'][index % 5]
      }
    }))

    return {
      backgroundColor: 'transparent',
      title: {
        text: 'ATMä¸šåŠ¡çœä»½åˆ†å¸ƒ',
        left: 'center',
        top: 20,
        textStyle: {
          color: '#374151',
          fontSize: 14,
          fontWeight: 'bold'
        }
      },
      tooltip: {
        trigger: 'item',
        backgroundColor: 'rgba(255, 255, 255, 0.95)',
        borderColor: '#e5e7eb',
        borderWidth: 1,
        textStyle: {
          color: '#374151',
          fontSize: 12
        },
        formatter: (params: any) => {
          return `
            <div style="font-weight: 600; margin-bottom: 4px;">${params.name}</div>
            <div>äº¤æ˜“æ¬¡æ•°: ${formatNumber(params.value)}</div>
            <div>å æ¯”: ${params.percent}%</div>
          `
        }
      },
      legend: {
        orient: 'vertical',
        left: '5%',
        top: 'center',
        textStyle: {
          color: '#6b7280',
          fontSize: 11
        }
      },
      series: [{
        name: 'ATMçœä»½åˆ†å¸ƒ',
        type: 'pie',
        radius: ['35%', '65%'],
        center: ['60%', '50%'],
        data: data,
        itemStyle: {
          borderRadius: 8,
          borderColor: '#fff',
          borderWidth: 2
        }
      }]
    }
  } else if (selectedBusinessType.value === 'fx') {
    // FXä¸šåŠ¡ï¼šæ˜¾ç¤ºå¸ç§åˆ†å¸ƒ - æ›´ç°ä»£åŒ–çš„è®¾è®¡
    const data = fxData.value.kindData.map((item, index) => ({
      name: item.kind,
      value: item.total,
      itemStyle: {
        color: {
          type: 'radial',
          x: 0.5, y: 0.5, r: 0.8,
          colorStops: [
            { offset: 0, color: ['#10b981', '#059669', '#34d399', '#6ee7b7'][index % 4] },
            { offset: 1, color: ['#047857', '#065f46', '#10b981', '#059669'][index % 4] }
          ]
        }
      }
    }))

    return {
      backgroundColor: 'transparent',
      title: {
        text: 'FXä¸šåŠ¡å¸ç§åˆ†å¸ƒ',
        subtext: `æ€»äº¤æ˜“é‡: ${formatNumber(fxData.value.total)}`,
        left: 'center',
        top: 15,
        textStyle: {
          color: '#374151',
          fontSize: 16,
          fontWeight: 'bold'
        },
        subtextStyle: {
          color: '#6b7280',
          fontSize: 12
        }
      },
      tooltip: {
        trigger: 'item',
        backgroundColor: 'rgba(255, 255, 255, 0.98)',
        borderColor: '#10b981',
        borderWidth: 2,
        textStyle: {
          color: '#374151',
          fontSize: 12
        },
        formatter: (params: any) => {
          const percentage = ((params.value / fxData.value.total) * 100).toFixed(1)
          return `
            <div style="font-weight: 600; margin-bottom: 6px; color: #10b981;">${params.name}</div>
            <div style="margin-bottom: 2px;">äº¤æ˜“æ¬¡æ•°: <strong>${formatNumber(params.value)}</strong></div>
            <div style="margin-bottom: 2px;">å æ¯”: <strong>${percentage}%</strong></div>
            <div>é‡‘é¢: <strong>${formatCurrency(params.value * 22150)}</strong></div>
          `
        }
      },
      legend: {
        orient: 'vertical',
        left: '8%',
        top: 'center',
        textStyle: {
          color: '#374151',
          fontSize: 12,
          fontWeight: '500'
        },
        itemWidth: 12,
        itemHeight: 8,
        itemGap: 12
      },
      series: [{
        name: 'FXå¸ç§åˆ†å¸ƒ',
        type: 'pie',
        radius: ['40%', '70%'],
        center: ['65%', '55%'],
        avoidLabelOverlap: false,
        data: data,
        itemStyle: {
          borderRadius: 10,
          borderColor: '#fff',
          borderWidth: 3,
          shadowBlur: 10,
          shadowColor: 'rgba(16, 185, 129, 0.3)'
        },
        label: {
          show: true,
          position: 'outside',
          color: '#374151',
          fontSize: 11,
          fontWeight: '600',
          formatter: '{b}\n{d}%'
        },
        labelLine: {
          show: true,
          length: 15,
          length2: 10,
          lineStyle: {
            color: '#10b981',
            width: 2
          }
        },
        emphasis: {
          itemStyle: {
            shadowBlur: 20,
            shadowColor: 'rgba(16, 185, 129, 0.5)',
            scale: true,
            scaleSize: 5
          }
        }
      }]
    }
  } else {
    // å…¨éƒ¨ä¸šåŠ¡ï¼šæ˜¾ç¤ºä¸šåŠ¡ç±»å‹å¯¹æ¯”
    const data = [
      {
        name: 'ATMä¸šåŠ¡',
        value: atmData.value.totalTransactions,
        itemStyle: {
          color: {
            type: 'linear',
            x: 0, y: 0, x2: 1, y2: 1,
            colorStops: [
              { offset: 0, color: '#3b82f6' },
              { offset: 1, color: '#1d4ed8' }
            ]
          }
        }
      },
      {
        name: 'å¤–æ±‡ä¸šåŠ¡',
        value: fxData.value.total,
        itemStyle: {
          color: {
            type: 'linear',
            x: 0, y: 0, x2: 1, y2: 1,
            colorStops: [
              { offset: 0, color: '#10b981' },
              { offset: 1, color: '#059669' }
            ]
          }
        }
      }
    ]

    return {
    backgroundColor: 'transparent',
    tooltip: {
      trigger: 'item',
      backgroundColor: 'rgba(255, 255, 255, 0.95)',
      borderColor: '#e5e7eb',
      borderWidth: 1,
      textStyle: {
        color: '#374151',
        fontSize: 12
      },
      formatter: (params: any) => {
        return `
          <div style="font-weight: 600; margin-bottom: 4px;">${params.name}</div>
          <div>äº¤æ˜“ç¬”æ•°: ${formatNumber(params.value)}</div>
          <div>å æ¯”: ${params.percent}%</div>
        `
      }
    },
    legend: {
      orient: 'vertical',
      left: '5%',
      top: 'center',
      textStyle: {
        color: '#6b7280',
        fontSize: 11
      },
      itemWidth: 10,
      itemHeight: 6
    },
    series: [
      {
        name: 'ä¸šåŠ¡ç±»å‹åˆ†å¸ƒ',
        type: 'pie',
        radius: ['35%', '65%'],
        center: ['60%', '50%'],
        avoidLabelOverlap: false,
        itemStyle: {
          borderRadius: 8,
          borderColor: '#fff',
          borderWidth: 2
        },
        label: {
          show: false,
          position: 'center'
        },
        emphasis: {
          label: {
            show: true,
            fontSize: 16,
            fontWeight: 'bold',
            color: '#374151'
          },
          itemStyle: {
            shadowBlur: 10,
            shadowOffsetX: 0,
            shadowColor: 'rgba(0, 0, 0, 0.5)'
          }
        },
        labelLine: {
          show: false
        },
        data: data
      }]
    }
  }
})

/**
 * ATMè¯¦ç»†åˆ†æå›¾è¡¨é…ç½® - æ˜¾ç¤ºé‡‘é¢åˆ†å¸ƒ
 */
const atmDetailChartOption = computed(() => {
  const amountData = atmData.value.amountDistribution
  if (!amountData || amountData.length === 0) return {}

  return {
    backgroundColor: 'transparent',
    tooltip: {
      trigger: 'item',
      backgroundColor: 'rgba(255, 255, 255, 0.95)',
      borderColor: '#e5e7eb',
      borderWidth: 1,
      textStyle: {
        color: '#374151',
        fontSize: 11
      },
      formatter: (params: any) => {
        return `
          <div style="font-weight: 600; margin-bottom: 4px;">${params.name}</div>
          <div>äº¤æ˜“ç¬”æ•°: ${formatNumber(params.value)}</div>
          <div>å æ¯”: ${params.percent}%</div>
        `
      }
    },
    legend: {
      bottom: 10,
      textStyle: {
        color: '#6b7280',
        fontSize: 11
      }
    },
    series: [
      {
        name: 'ATMé‡‘é¢åˆ†å¸ƒ',
        type: 'pie',
        radius: ['30%', '60%'],
        center: ['50%', '45%'],
        data: amountData.map((item, index) => ({
          name: item.amountLevel,
          value: item.total,
          itemStyle: {
            color: ['#3b82f6', '#1d4ed8', '#60a5fa', '#93c5fd', '#dbeafe'][index % 5]
          }
        })),
        itemStyle: {
          borderRadius: 4,
          borderColor: '#fff',
          borderWidth: 1
        }
      }
    ]
  }
})

/**
 * FXè¯¦ç»†åˆ†æå›¾è¡¨é…ç½® - æ˜¾ç¤ºç›®çš„åˆ†å¸ƒ
 */
const fxDetailChartOption = computed(() => {
  const purposeData = fxData.value.purposeData
  if (!purposeData || purposeData.length === 0) return {}

  return {
    backgroundColor: 'transparent',
    tooltip: {
      trigger: 'axis',
      backgroundColor: 'rgba(255, 255, 255, 0.95)',
      borderColor: '#e5e7eb',
      borderWidth: 1,
      textStyle: {
        color: '#374151',
        fontSize: 11
      }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '5%',
      top: '8%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: purposeData.map(item => item.purpose),
      axisLine: {
        lineStyle: { color: '#e5e7eb' }
      },
      axisLabel: {
        color: '#9ca3af',
        fontSize: 10
      }
    },
    yAxis: {
      type: 'value',
      axisLine: { show: false },
      axisTick: { show: false },
      axisLabel: {
        color: '#9ca3af',
        fontSize: 10
      },
      splitLine: {
        lineStyle: {
          color: '#f3f4f6',
          type: 'dashed'
        }
      }
    },
    series: [
      {
        name: 'FXç›®çš„åˆ†å¸ƒ',
        type: 'bar',
        data: purposeData.map(item => item.total),
        itemStyle: {
          color: {
            type: 'linear',
            x: 0, y: 0, x2: 0, y2: 1,
            colorStops: [
              { offset: 0, color: '#10b981' },
              { offset: 1, color: '#059669' }
            ]
          },
          borderRadius: [4, 4, 0, 0]
        },
        barWidth: '60%'
      }
    ]
  }
})

/**
 * ATMçœä»½åˆ†å¸ƒå›¾è¡¨é…ç½®
 */
const atmProvinceChartOption = computed(() => {
  const provinceData = atmData.value.provinceData
  if (!provinceData || provinceData.length === 0) return {}

  return {
    backgroundColor: 'transparent',
    tooltip: {
      trigger: 'item',
      backgroundColor: 'rgba(255, 255, 255, 0.95)',
      borderColor: '#e5e7eb',
      borderWidth: 1,
      textStyle: {
        color: '#374151',
        fontSize: 11
      },
      formatter: (params: any) => {
        return `
          <div style="font-weight: 600; margin-bottom: 4px;">${params.name}</div>
          <div>äº¤æ˜“æ¬¡æ•°: ${formatNumber(params.value)}</div>
          <div>å æ¯”: ${params.percent}%</div>
        `
      }
    },
    legend: {
      bottom: 10,
      textStyle: {
        color: '#6b7280',
        fontSize: 11
      }
    },
    series: [
      {
        name: 'ATMçœä»½åˆ†å¸ƒ',
        type: 'pie',
        radius: ['30%', '60%'],
        center: ['50%', '45%'],
        data: provinceData.map((item, index) => ({
          name: item.province,
          value: item.transcation_times,
          itemStyle: {
            color: ['#3b82f6', '#1d4ed8', '#60a5fa', '#93c5fd', '#dbeafe'][index % 5]
          }
        })),
        itemStyle: {
          borderRadius: 4,
          borderColor: '#fff',
          borderWidth: 1
        }
      }
    ]
  }
})

/**
 * FXå¸ç§åˆ†å¸ƒå›¾è¡¨é…ç½®
 */
const fxKindChartOption = computed(() => {
  const kindData = fxData.value.kindData
  if (!kindData || kindData.length === 0) return {}

  return {
    backgroundColor: 'transparent',
    tooltip: {
      trigger: 'item',
      backgroundColor: 'rgba(255, 255, 255, 0.95)',
      borderColor: '#e5e7eb',
      borderWidth: 1,
      textStyle: {
        color: '#374151',
        fontSize: 11
      },
      formatter: (params: any) => {
        return `
          <div style="font-weight: 600; margin-bottom: 4px;">${params.name}</div>
          <div>äº¤æ˜“æ¬¡æ•°: ${formatNumber(params.value)}</div>
          <div>å æ¯”: ${params.percent}%</div>
        `
      }
    },
    legend: {
      bottom: 5,
      textStyle: {
        color: '#6b7280',
        fontSize: 10
      }
    },
    series: [
      {
        name: 'FXå¸ç§åˆ†å¸ƒ',
        type: 'pie',
        radius: ['30%', '65%'],
        center: ['50%', '50%'],
        data: kindData.map((item, index) => ({
          name: item.kind,
          value: item.total,
          itemStyle: {
            color: ['#10b981', '#059669', '#34d399', '#6ee7b7', '#a7f3d0'][index % 5]
          }
        })),
        itemStyle: {
          borderRadius: 4,
          borderColor: '#fff',
          borderWidth: 1
        }
      }
    ]
  }
})

/**
 * FXå¹´é¾„åˆ†å¸ƒå›¾è¡¨é…ç½®
 */
const fxAgeChartOption = computed(() => {
  const ageData = fxData.value.ageData
  if (!ageData || ageData.length === 0) return {}

  return {
    backgroundColor: 'transparent',
    tooltip: {
      trigger: 'axis',
      backgroundColor: 'rgba(255, 255, 255, 0.95)',
      borderColor: '#e5e7eb',
      borderWidth: 1,
      textStyle: {
        color: '#374151',
        fontSize: 11
      }
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '5%',
      top: '8%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: ageData.map(item => item.ageLevel),
      axisLine: {
        lineStyle: { color: '#e5e7eb' }
      },
      axisLabel: {
        color: '#9ca3af',
        fontSize: 10
      }
    },
    yAxis: {
      type: 'value',
      axisLine: { show: false },
      axisTick: { show: false },
      axisLabel: {
        color: '#9ca3af',
        fontSize: 10
      },
      splitLine: {
        lineStyle: {
          color: '#f3f4f6',
          type: 'dashed'
        }
      }
    },
    series: [
      {
        name: 'FXå¹´é¾„åˆ†å¸ƒ',
        type: 'bar',
        data: ageData.map(item => item.total),
        itemStyle: {
          color: {
            type: 'linear',
            x: 0, y: 0, x2: 0, y2: 1,
            colorStops: [
              { offset: 0, color: '#10b981' },
              { offset: 1, color: '#059669' }
            ]
          },
          borderRadius: [4, 4, 0, 0]
        },
        barWidth: '60%'
      }
    ]
  }
})

/**
 * å¯¹æ¯”åˆ†æå›¾è¡¨é…ç½®
 */
const comparisonChartOption = computed(() => {
  return {
    backgroundColor: 'transparent',
    tooltip: {
      trigger: 'axis',
      backgroundColor: 'rgba(255, 255, 255, 0.95)',
      borderColor: '#e5e7eb',
      borderWidth: 1,
      textStyle: {
        color: '#374151',
        fontSize: 12
      }
    },
    legend: {
      top: 10,
      textStyle: {
        color: '#6b7280',
        fontSize: 12
      }
    },
    grid: {
      left: '8%',
      right: '8%',
      bottom: '12%',
      top: '20%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: ['äº¤æ˜“ç¬”æ•°', 'æ€»é‡‘é¢', 'å¹³å‡é‡‘é¢', 'å¢é•¿ç‡'],
      axisLine: {
        lineStyle: { color: '#e5e7eb' }
      },
      axisLabel: {
        color: '#9ca3af',
        fontSize: 11
      }
    },
    yAxis: [
      {
        type: 'value',
        name: 'æ•°å€¼',
        position: 'left',
        axisLine: { show: false },
        axisTick: { show: false },
        axisLabel: {
          color: '#9ca3af',
          fontSize: 11
        },
        splitLine: {
          lineStyle: {
            color: '#f3f4f6',
            type: 'dashed'
          }
        }
      },
      {
        type: 'value',
        name: 'ç™¾åˆ†æ¯”',
        position: 'right',
        axisLine: { show: false },
        axisTick: { show: false },
        axisLabel: {
          color: '#9ca3af',
          fontSize: 11,
          formatter: '{value}%'
        },
        splitLine: { show: false }
      }
    ],
    series: [
      {
        name: 'ATMä¸šåŠ¡',
        type: 'bar',
        yAxisIndex: 0,
        data: [
          atmData.value.totalTransactions / 1000,
          atmData.value.totalAmount / 10000000,
          atmData.value.avgAmount / 1000,
          atmData.value.trend
        ],
        itemStyle: {
          color: {
            type: 'linear',
            x: 0, y: 0, x2: 0, y2: 1,
            colorStops: [
              { offset: 0, color: '#3b82f6' },
              { offset: 1, color: '#1d4ed8' }
            ]
          },
          borderRadius: [4, 4, 0, 0]
        },
        barWidth: '30%'
      },
      {
        name: 'å¤–æ±‡ä¸šåŠ¡',
        type: 'bar',
        yAxisIndex: 0,
        data: [
          fxData.value.total / 1000,
          fxData.value.sumAmount / 10000000,
          fxData.value.avgAmount / 1000,
          fxData.value.trend
        ],
        itemStyle: {
          color: {
            type: 'linear',
            x: 0, y: 0, x2: 0, y2: 1,
            colorStops: [
              { offset: 0, color: '#10b981' },
              { offset: 1, color: '#059669' }
            ]
          },
          borderRadius: [4, 4, 0, 0]
        },
        barWidth: '30%'
      }
    ]
  }
})

/**
 * ATMå¯¹æ¯”åˆ†æå›¾è¡¨é…ç½®
 */
const atmComparisonChartOption = computed(() => {
  const provinceData = atmData.value.provinceData.map(item => item.transcation_times)
  const amountData = atmData.value.amountDistribution.map(item => item.total)

  return {
    backgroundColor: 'transparent',
    tooltip: {
      trigger: 'axis',
      backgroundColor: 'rgba(255, 255, 255, 0.95)',
      borderColor: '#e5e7eb',
      borderWidth: 1,
      textStyle: {
        color: '#374151',
        fontSize: 12
      }
    },
    legend: {
      top: 10,
      textStyle: {
        color: '#6b7280',
        fontSize: 12
      }
    },
    grid: {
      left: '8%',
      right: '8%',
      bottom: '12%',
      top: '20%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      data: ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿ä¸œ', 'æ±Ÿè‹', 'æµ™æ±Ÿ'],
      axisLine: {
        lineStyle: { color: '#e5e7eb' }
      },
      axisLabel: {
        color: '#9ca3af',
        fontSize: 11
      }
    },
    yAxis: {
      type: 'value',
      axisLine: { show: false },
      axisTick: { show: false },
      axisLabel: {
        color: '#9ca3af',
        fontSize: 11
      },
      splitLine: {
        lineStyle: {
          color: '#f3f4f6',
          type: 'dashed'
        }
      }
    },
    series: [
      {
        name: 'çœä»½äº¤æ˜“é‡',
        type: 'bar',
        data: provinceData,
        itemStyle: {
          color: {
            type: 'linear',
            x: 0, y: 0, x2: 0, y2: 1,
            colorStops: [
              { offset: 0, color: '#3b82f6' },
              { offset: 1, color: '#1d4ed8' }
            ]
          },
          borderRadius: [4, 4, 0, 0]
        },
        barWidth: '60%'
      }
    ]
  }
})

/**
 * å·¥å…·å‡½æ•°
 */
const formatNumber = (value: number) => {
  return value.toLocaleString()
}

const formatCurrency = (value: number) => {
  return `Â¥${(value / 10000).toFixed(1)}ä¸‡`
}

const getTopCurrency = () => {
  if (fxData.value.kindData.length === 0) return 'USD'
  const sortedKinds = [...fxData.value.kindData].sort((a, b) => b.total - a.total)
  return sortedKinds[0]?.kind || 'USD'
}

const getTopPurpose = () => {
  if (fxData.value.purposeData.length === 0) return 'æ—…æ¸¸'
  const sortedPurposes = [...fxData.value.purposeData].sort((a, b) => b.total - a.total)
  return sortedPurposes[0]?.purpose || 'æ—…æ¸¸'
}

const getTopProvince = () => {
  // åˆå¹¶ATMå’ŒFXçš„çœä»½æ•°æ®ï¼Œæ‰¾å‡ºäº¤æ˜“é‡æœ€é«˜çš„çœä»½
  const allProvinces: { [key: string]: number } = {}

  // æ·»åŠ ATMçœä»½æ•°æ®
  atmData.value.provinceData.forEach(item => {
    allProvinces[item.province] = (allProvinces[item.province] || 0) + item.transcation_times
  })

  // æ·»åŠ FXçœä»½æ•°æ®
  fxData.value.provinceData.forEach(item => {
    allProvinces[item.province] = (allProvinces[item.province] || 0) + item.total
  })

  // æ‰¾å‡ºäº¤æ˜“é‡æœ€é«˜çš„çœä»½
  const sortedProvinces = Object.entries(allProvinces).sort((a, b) => b[1] - a[1])
  return sortedProvinces[0]?.[0] || 'åŒ—äº¬'
}

const getTopAtmProvince = () => {
  if (atmData.value.provinceData.length === 0) return 'åŒ—äº¬'
  const sortedProvinces = [...atmData.value.provinceData].sort((a, b) => b.transcation_times - a.transcation_times)
  return sortedProvinces[0]?.province || 'åŒ—äº¬'
}

const getTopAtmAmount = () => {
  if (atmData.value.amountDistribution.length === 0) return '1000-5000'
  const sortedAmounts = [...atmData.value.amountDistribution].sort((a, b) => b.total - a.total)
  return sortedAmounts[0]?.amountLevel || '1000-5000'
}

/**
 * äº‹ä»¶å¤„ç†å‡½æ•°
 */
const handleBusinessTypeChange = () => {
  console.log('ä¸šåŠ¡ç±»å‹åˆ‡æ¢ä¸º:', selectedBusinessType.value)
  refreshData()
}

const handleDisplayModeChange = () => {
  console.log('æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢ä¸º:', displayMode.value)
}

const handleChartClick = (params: any) => {
  console.log('å›¾è¡¨ç‚¹å‡»äº‹ä»¶:', params)
  if (params.componentType === 'series') {
    console.log('ç‚¹å‡»ä¸šåŠ¡ç±»å‹:', params.name)
  }
}

const refreshData = async () => {
  if (isLoading.value) return

  isLoading.value = true
  console.log('æ­£åœ¨åˆ·æ–°ä¸šåŠ¡ç±»å‹æ•°æ®...')

  try {
    // ä¸´æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æ¥å±•ç¤ºATMè¯¦ç»†åˆ†ææ•ˆæœ
    console.log('ğŸ¯ ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®å±•ç¤ºATMä¸šåŠ¡è¯¦ç»†åˆ†æ')

    // ä¿æŒå½“å‰çš„æ¨¡æ‹Ÿæ•°æ®ä¸å˜ï¼Œç¡®ä¿å›¾è¡¨èƒ½æ­£å¸¸æ˜¾ç¤º
    console.log('ATMæ¨¡æ‹Ÿæ•°æ®:', {
      totalTransactions: atmData.value.totalTransactions,
      provinceCount: atmData.value.provinceData.length,
      amountLevels: atmData.value.amountDistribution.length
    })

    // å¦‚æœéœ€è¦åç«¯æ•°æ®ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢çš„æ³¨é‡Š
    // const backendData = await fetchBusinessDataFromBackend()
    // if (backendData) {
    //   atmData.value = backendData.atm
    //   fxData.value = backendData.fx
    // }

    console.log('âœ… ä¸šåŠ¡ç±»å‹æ•°æ®åˆ·æ–°å®Œæˆï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰')
  } catch (error) {
    console.error('æ•°æ®åˆ·æ–°å¤±è´¥:', error)
    // å¤±è´¥æ—¶ä¿æŒæ¨¡æ‹Ÿæ•°æ®
  } finally {
    isLoading.value = false
  }
}

/**
 * åç«¯æ•°æ®è·å–å‡½æ•°
 */
const fetchBusinessDataFromBackend = async (): Promise<{ atm: ATMData, fx: FXData } | null> => {
  try {
    console.log('æ­£åœ¨ä»åç«¯è·å–ä¸šåŠ¡ç±»å‹æ•°æ®...', {
      businessType: selectedBusinessType.value,
      displayMode: displayMode.value
    })

    // è°ƒç”¨ä¸»è¿›ç¨‹çš„IPCæ¥å£è·å–ä¸šåŠ¡æ•°æ®
    const response = await (window.api as any).fetchBusinessData({
      businessType: selectedBusinessType.value,
      analysisType: displayMode.value
    })
    console.log('åç«¯è¿”å›çš„æ•°æ®:', response)

    const data = response.data

    // å¤„ç†ATMæ•°æ®
    const atmData: ATMData = {
      // è®¡ç®—æ€»ä½“æŒ‡æ ‡
      totalTransactions: data.atm?.province?.reduce((sum: number, item: any) => sum + (item.transcation_times || 0), 0) || 0,
      totalAmount: data.atm?.province?.reduce((sum: number, item: any) => sum + (item.sum_amount || 0), 0) || 0,
      avgAmount: 0, // åé¢è®¡ç®—
      trend: Math.random() * 10 - 5, // ä¸´æ—¶éšæœºå€¼ï¼Œç­‰åç«¯æä¾›
      percentage: 0, // åé¢è®¡ç®—

      // çœä»½åˆ†å¸ƒæ•°æ®ï¼ˆç›´æ¥ä½¿ç”¨åç«¯æ•°æ®ï¼‰
      provinceData: data.atm?.province || [],

      // é‡‘é¢åˆ†å¸ƒæ•°æ®ï¼ˆç›´æ¥ä½¿ç”¨åç«¯æ•°æ®ï¼‰
      amountDistribution: data.atm?.amount || [],

      // KPIæ•°æ®ï¼ˆç›´æ¥ä½¿ç”¨åç«¯æ•°æ®ï¼‰
      kpiData: data.atm?.kpi || []
    }

    // å¤„ç†FXæ•°æ®
    const fxData: FXData = {
      // è®¡ç®—æ€»ä½“æŒ‡æ ‡
      total: data.fx?.province?.reduce((sum: number, item: any) => sum + (item.total || 0), 0) || 0,
      sumAmount: data.fx?.province?.reduce((sum: number, item: any) => sum + (item.sumAmount || 0), 0) || 0,
      avgAmount: 0, // åé¢è®¡ç®—
      trend: Math.random() * 10 - 5, // ä¸´æ—¶éšæœºå€¼ï¼Œç­‰åç«¯æä¾›
      percentage: 0, // åé¢è®¡ç®—

      // å„ç»´åº¦åˆ†å¸ƒæ•°æ®ï¼ˆç›´æ¥ä½¿ç”¨åç«¯æ•°æ®ï¼‰
      provinceData: data.fx?.province || [],
      purposeData: data.fx?.purpose || [],
      kindData: data.fx?.kind || [],
      ageData: data.fx?.age || [],
      kpiData: data.fx?.kpi || []
    }

    // // è®¡ç®—å¹³å‡é‡‘é¢
    // atmData.avgAmount = atmData.totalTransactions > 0 ? atmData.totalAmount / atmData.totalTransactions : 0
    // fxData.avgAmount = fxData.totalTransactions > 0 ? fxData.totalAmount / fxData.totalTransactions : 0

    // // è®¡ç®—ç™¾åˆ†æ¯”
    // const totalTransactions = atmData.totalTransactions + fxData.totalTransactions
    // if (totalTransactions > 0) {
    //   atmData.percentage = Number(((atmData.totalTransactions / totalTransactions) * 100).toFixed(1))
    //   fxData.percentage = Number(((fxData.totalTransactions / totalTransactions) * 100).toFixed(1))
    // }

    return { atm: atmData, fx: fxData }
  } catch (error) {
    console.error('åç«¯æ•°æ®è·å–å¤±è´¥:', error)
    return null
  }
}

/**
 * ç”Ÿå‘½å‘¨æœŸé’©å­
 */
onMounted(() => {
  console.log('ğŸš€ ä¸šåŠ¡ç±»å‹åˆ†å¸ƒå›¾è¡¨ç»„ä»¶å·²æŒ‚è½½')

  console.log('å½“å‰ä¸šåŠ¡ç±»å‹:', selectedBusinessType.value)
  console.log('å½“å‰æ˜¾ç¤ºæ¨¡å¼:', displayMode.value)

  // æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®ä¿¡æ¯
  console.log('ğŸ“Š ATMæ¨¡æ‹Ÿæ•°æ®æ¦‚è§ˆ:', {
    totalTransactions: atmData.value.totalTransactions,
    totalAmount: atmData.value.totalAmount,
    provinceCount: atmData.value.provinceData.length,
    amountLevels: atmData.value.amountDistribution.length,
    provinces: atmData.value.provinceData.map(p => p.province),
    amountLevels_detail: atmData.value.amountDistribution.map(a => a.amountLevel)
  })

  console.log('ğŸ’± FXæ¨¡æ‹Ÿæ•°æ®æ¦‚è§ˆ:', {
    total: fxData.value.total,
    sumAmount: fxData.value.sumAmount,
    provinceCount: fxData.value.provinceData.length,
    purposeCount: fxData.value.purposeData.length,
    kindCount: fxData.value.kindData.length,
    ageCount: fxData.value.ageData.length
  })

  // åˆå§‹åŒ–æ•°æ®
  refreshData()

  // è®¾ç½®è‡ªåŠ¨åˆ·æ–°
  if (props.autoRefresh && props.refreshInterval > 0) {
    const interval = setInterval(() => {
      refreshData()
    }, props.refreshInterval)

    // ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
    onUnmounted(() => {
      clearInterval(interval)
    })
  }
})

onUnmounted(() => {
  console.log('ğŸ”„ ä¸šåŠ¡ç±»å‹åˆ†å¸ƒå›¾è¡¨ç»„ä»¶å¼€å§‹å¸è½½...')

  // é‡ç½®çŠ¶æ€
  isLoading.value = false
  selectedBusinessType.value = 'all'
  displayMode.value = 'overview'

  console.log('âœ… ä¸šåŠ¡ç±»å‹åˆ†å¸ƒå›¾è¡¨ç»„ä»¶å¸è½½å®Œæˆ')
})

/**
 * ç›‘å¬å™¨
 */
watch(selectedBusinessType, (newType) => {
  console.log('ä¸šåŠ¡ç±»å‹å˜æ›´:', newType)
  // å¯ä»¥æ ¹æ®ä¸šåŠ¡ç±»å‹è¿‡æ»¤æ•°æ®
})

watch(displayMode, (newMode) => {
  console.log('æ˜¾ç¤ºæ¨¡å¼å˜æ›´:', newMode)
  // å¯ä»¥æ ¹æ®æ˜¾ç¤ºæ¨¡å¼è°ƒæ•´å›¾è¡¨é…ç½®
})
</script>

<style scoped>
.chart-container {
  transition: all 0.3s ease;
}

.chart-container:hover {
  box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

/* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
.overflow-y-auto::-webkit-scrollbar {
  width: 4px;
}

.overflow-y-auto::-webkit-scrollbar-track {
  background: transparent;
}

.overflow-y-auto::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 2px;
}

.overflow-y-auto::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* å›¾è¡¨å®¹å™¨åŠ¨ç”» */
.v-chart {
  transition: opacity 0.3s ease;
}

/* ç»Ÿè®¡å¡ç‰‡æ‚¬åœæ•ˆæœ */
.bg-gradient-to-r:hover {
  transform: translateY(-2px);
  transition: transform 0.2s ease;
}

/* ä¸šåŠ¡ç±»å‹æ ‡ç­¾æ ·å¼ */
.business-type-label {
  position: relative;
  overflow: hidden;
}

.business-type-label::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s;
}

.business-type-label:hover::before {
  left: 100%;
}

/* ğŸš€ æ€»è§ˆæ¨¡å¼ä¸“å±åŠ¨ç”»æ•ˆæœ */

/* 1. KPIå¡ç‰‡çš„å‘¼å¸å’Œæ‚¬æµ®æ•ˆæœ */
@keyframes overview-card-float {
  0%, 100% {
    transform: translateY(0px) scale(1);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  }
  50% {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  }
}

.overview-kpi-card {
  animation: overview-card-float 4s ease-in-out infinite;
  background-size: 200% 200%;
}

/* é”™å¼€KPIå¡ç‰‡åŠ¨ç”»æ—¶é—´ */
.overview-kpi-card:nth-child(1) { animation-delay: 0s; }
.overview-kpi-card:nth-child(2) { animation-delay: 1s; }
.overview-kpi-card:nth-child(3) { animation-delay: 2s; }
.overview-kpi-card:nth-child(4) { animation-delay: 3s; }

/* 2. æ‚¬æµ®æ—¶çš„ç‰¹æ®Šæ•ˆæœ */
.overview-kpi-card:hover {
  animation-play-state: paused;
  transform: translateY(-8px) scale(1.05) !important;
}

/* 3. å›¾æ ‡æ—‹è½¬æ•ˆæœ */
@keyframes icon-rotate-subtle {
  0%, 100% { transform: rotate(0deg); }
  25% { transform: rotate(2deg); }
  75% { transform: rotate(-2deg); }
}

.overview-kpi-card .w-12 {
  animation: icon-rotate-subtle 4s ease-in-out infinite;
}

/* 4. æ´å¯Ÿå¡ç‰‡çš„è½»å¾®åŠ¨ç”» */
@keyframes insight-card-breathe {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
  }
  50% {
    transform: scale(1.01);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
  }
}

/* 5. æ’è¡Œæ¦œé¡¹ç›®çš„æ¸å…¥åŠ¨ç”» */
@keyframes ranking-item-slide {
  0% {
    opacity: 0;
    transform: translateX(-20px);
  }
  100% {
    opacity: 1;
    transform: translateX(0);
  }
}

/* 6. è¿›åº¦æ¡åŠ¨ç”» */
@keyframes progress-fill {
  0% { width: 0%; }
  100% { width: 85%; }
}

.bg-gradient-to-r.from-blue-500.to-emerald-500 {
  animation: progress-fill 2s ease-out 1s both;
}

/* 7. å‡å°‘åŠ¨ç”»åå¥½çš„ç”¨æˆ· */
@media (prefers-reduced-motion: reduce) {
  .overview-kpi-card,
  .overview-kpi-card .w-12 {
    animation: none;
  }
}
</style>
